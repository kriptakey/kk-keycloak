<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KK-Tokenization Service Setup and Configuration &mdash; Kripta Key Documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b20cc3f5" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=03d93ebb"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="KK-Tokenization Service Backup and Restore" href="kkts-backuprestore.html" />
    <link rel="prev" title="Design motivation" href="design-motivation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Kripta Key Documentation
          </a>
              <div class="version">
                24.1.0015-RC-UP02
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../revision-history.html">Revision History</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../kripta-key-primer.html">Kripta Key Primer</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation-guide/index.html">Installation Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../clikk-installation-guide/index.html">CLIKK Installation Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cloud-installation-guide/index.html">Cloud Installation Guide</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">KK-TS Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#preface">Preface</a></li>
<li class="toctree-l2"><a class="reference internal" href="design-motivation.html">Design motivation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">KK-Tokenization Service Setup and Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#preparatory-steps">Preparatory steps</a></li>
<li class="toctree-l3"><a class="reference internal" href="#installing-kk-tokenization-service">Installing KK-Tokenization Service</a></li>
<li class="toctree-l3"><a class="reference internal" href="#apache-cassandra-configuration">Apache Cassandra Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cqlsh-setup">Cqlsh Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#kk-ts-namespace-setup">KK-TS Namespace Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#yaml-configuration">YAML Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#jvm-configuration">JVM Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-kk-ts-to-kk-cs-and-apache-cassandra">Configuring KK-TS to KK-CS and Apache Cassandra</a></li>
<li class="toctree-l3"><a class="reference internal" href="#apply-kk-ts-license-and-run-the-kk-ts">Apply KK-TS License and Run the KK-TS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generating-client-certificate-and-configuring-the-client-application-to-kk-ts">Generating Client Certificate and Configuring the Client Application to KK-TS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="kkts-backuprestore.html">KK-Tokenization Service Backup and Restore</a></li>
<li class="toctree-l2"><a class="reference internal" href="cassandra-setting-consideration.html">Apache Cassandra Setting Consideration</a></li>
<li class="toctree-l2"><a class="reference internal" href="cassandra-setting-recommendation.html">Apache Cassandra Setting Recommendation</a></li>
<li class="toctree-l2"><a class="reference internal" href="domain-configuration.html">Domain configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="kkts-license.html">KK-TS License</a></li>
<li class="toctree-l2"><a class="reference internal" href="command-line-interface.html">KK-TS command line interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="kms-tokenization-services.html">Tokenization services</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tdp-installation-guide/index.html">TDP Installation Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../license-guide/index.html">License Application Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../sys-admin-guide/index.html">System Administrator Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dev-guide/index.html">Developer Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../e2ee-dev-guide/index.html">E2EE Developer Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../func-module-guide/index.html">Functional Module Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../app-integration-guide/index.html">App Integration Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../keycloak-integration-guide/index.html">KeyCloak Integration Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../sdk-api-docs/index.html">SDK API Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../rest-api-docs/index.html">REST API Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../whitepaper/index.html">Whitepaper</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../appendix.html">Appendix</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Kripta Key Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">KK-TS Guide</a></li>
      <li class="breadcrumb-item active">KK-Tokenization Service Setup and Configuration</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/kkts-guide/kkts-installation.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="kk-tokenization-service-setup-and-configuration">
<h1>KK-Tokenization Service Setup and Configuration<a class="headerlink" href="#kk-tokenization-service-setup-and-configuration" title="Link to this heading"></a></h1>
<p>KK-Tokenization Service provides tokenization services for client applications in vault-based system.
Authorized applications may connect to the KK-Tokenization Service instances to perform vaulted tokenization operations using keys that are stored in the KK-Manager database or otherwise created by the KK-Manager.
KK-TS is using Transport Layer Security (TLS) 1.3. To enable communication between KK-TS and its client, the client must also support TLS 1.3.</p>
<p>This section describes the steps required to install and configure KK-Tokenization Service.</p>
<section id="preparatory-steps">
<h2>Preparatory steps<a class="headerlink" href="#preparatory-steps" title="Link to this heading"></a></h2>
<p>Kripta Key Tokenization Service (KK-TS) requires Apache Cassandra database.
Apache Cassandra is an open-source noSQL database that distributes data over multiple commodity servers.
Cassandra uses a ring design rather than the master-slave design. KK-TS structures the database to store
<code class="docutils literal notranslate"><span class="pre">PartitionConfig</span></code>, <code class="docutils literal notranslate"><span class="pre">AppConfig</span></code>, <code class="docutils literal notranslate"><span class="pre">DataConfig</span></code>, <code class="docutils literal notranslate"><span class="pre">sessionCache</span></code>, <code class="docutils literal notranslate"><span class="pre">configCache</span></code>, and <code class="docutils literal notranslate"><span class="pre">dataDomains</span></code>.</p>
<p>Prepare Virtual Machine (VM)s for KK-Tokenization Service. KK-TS requires Apache Cassandra, which needs 2 VMs for two nodes.
KK-TS itself also requires a VM. The total number of Virtual Machines depends on the deployment model. The following are the VMs specifications.</p>
<blockquote>
<div><table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Specification</p></th>
<th class="head"><p>Cassandra Virtual Machine</p></th>
<th class="head"><p>KK-TS Virtual Machine</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>CPU</p></td>
<td><p>8 core</p></td>
<td><p>8 core</p></td>
</tr>
<tr class="row-odd"><td><p>RAM</p></td>
<td><p>minimum 32GB</p></td>
<td><p>minimum 16GB</p></td>
</tr>
<tr class="row-even"><td><p>NIC</p></td>
<td><p>10GB ethernet</p></td>
<td><p>10GB ethernet</p></td>
</tr>
<tr class="row-odd"><td><p>Operating System (OS)</p></td>
<td><p>RHEL 9.2</p></td>
<td><p>RHEL 9.2</p></td>
</tr>
<tr class="row-even"><td><p>Requirements</p></td>
<td><p>None</p></td>
<td><p>Setup and enable vTPM (please read the documentation of the VM Manager)</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul>
<li><p><strong>Notes</strong></p>
<blockquote>
<div><p>We recommend you to use vSphere as the VM Manager.</p>
</div></blockquote>
</li>
</ul>
</section>
<section id="installing-kk-tokenization-service">
<h2>Installing KK-Tokenization Service<a class="headerlink" href="#installing-kk-tokenization-service" title="Link to this heading"></a></h2>
<ol class="arabic">
<li><p>Run KK-NativeSDK, set the root user before the installation.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>chmod<span class="w"> </span><span class="m">755</span><span class="w"> </span>KK-NativeSDK.sh
<span class="gp">$ </span>./KK-NativeSDK.sh<span class="w"> </span>install<span class="w"> </span>&lt;username&gt;
</pre></div>
</div>
</li>
<li><p>Install KK-Tokenization Service from the package. Before doing the installation, set the root user</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>chmod<span class="w"> </span><span class="m">755</span><span class="w"> </span>kkts_installer.sh
<span class="gp">$ </span>./kkts_installer.sh<span class="w"> </span>install<span class="w"> </span>&lt;username&gt;
</pre></div>
</div>
</li>
<li><p>Register KK-Tokenization Service as application to KK-Manager.</p>
<p>Generate key and CSR. Register them to KK-Manager as key and CSR of KKTS application.</p>
<p>The following steps demonstrate the method of creating the CSR for an application that will be used to register
the application in Kripta Key. In this example, OpenSSL is used to create the KK-TS CSR.</p>
<ul>
<li><p>Generate the KK-TS key pair. This example generates an ECDSA P-256 key pair.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>ecparam<span class="w"> </span>-name<span class="w"> </span>prime256v1<span class="w"> </span>-genkey<span class="w"> </span>-noout<span class="w"> </span>-out<span class="w"> </span>KKTSprivate.key
</pre></div>
</div>
</li>
<li><p>Create the CSR for the key pair.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-sha256<span class="w"> </span>-key<span class="w"> </span>KKTSprivate.key<span class="w"> </span>-out<span class="w"> </span>KKTScsr.pem
</pre></div>
</div>
</li>
<li><p>Register the application using <code class="docutils literal notranslate"><span class="pre">clikk</span> <span class="pre">app</span> <span class="pre">add</span></code>, passing in the path to the CSR.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>clikk<span class="w"> </span>app<span class="w"> </span>add<span class="w"> </span>--csr-file-path<span class="o">=</span>KKTScsr.pem<span class="w"> </span>--app-id<span class="o">=</span>KKTS<span class="w"> </span>--validity-period<span class="o">=</span><span class="m">365</span><span class="w"> </span>--output-cert-path<span class="o">=</span>/home/user/Documents/KKTSCertificate.pem
</pre></div>
</div>
</li>
<li><p>Add the application to a partition using <code class="docutils literal notranslate"><span class="pre">clikk</span> <span class="pre">partition</span> <span class="pre">add-app</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>clikk<span class="w"> </span>partition<span class="w"> </span>add-app<span class="w"> </span>--partition-id<span class="o">=</span><span class="m">1</span><span class="w"> </span>--app-id<span class="o">=</span>KKTS
</pre></div>
</div>
</li>
<li><p>Ensure the partition has access to KK-Cryptoservice. If it has not, add the partition to the KK-Cryptoservice using <code class="docutils literal notranslate"><span class="pre">clikk</span> <span class="pre">kk-cryptoservice</span> <span class="pre">add-partition</span></code></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>clikk<span class="w"> </span>kk-cryptoservice<span class="w"> </span>add-partition<span class="w"> </span>--partition-id<span class="o">=</span><span class="m">1</span><span class="w"> </span>--kk-cryptoservice-name<span class="o">=</span>cryptoserviceOne
</pre></div>
</div>
</li>
</ul>
</li>
</ol>
</section>
<section id="apache-cassandra-configuration">
<h2>Apache Cassandra Configuration<a class="headerlink" href="#apache-cassandra-configuration" title="Link to this heading"></a></h2>
<p>Apache Cassandra requires 2 VMs for two nodes.</p>
<ol class="arabic">
<li><p>Prerequisites</p>
<ul>
<li><p>Install Java 11.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>java-11-openjdk
</pre></div>
</div>
</li>
<li><p>Install Python 3.9.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>python3
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>Apache Cassandra Installation</p>
<p>Before installation, adjust <a class="reference internal" href="cassandra-setting-recommendation.html#kernel-configuration"><span class="std std-ref">kernel configuration</span></a> and
<a class="reference internal" href="cassandra-setting-recommendation.html#disk-configuration"><span class="std std-ref">disk configuration</span></a> to optimize apache cassandra performance.</p>
<ul>
<li><p>Add Cassandra repositories, execute command below.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">sudo nano /etc/yum.repos.d/cassandra.repo</span>
</pre></div>
</div>
</li>
<li><p>Insert the following to cassandra.repo</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">[cassandra]</span>
<span class="go">name=Apache Cassandra</span>
<span class="go">baseurl=https://redhat.cassandra.apache.org/41x/</span>
<span class="go">gpgcheck=1</span>
<span class="go">repo_gpgcheck=1</span>
<span class="go">gpgkey=https://downloads.apache.org/cassandra/KEYS</span>
</pre></div>
</div>
</li>
<li><p>Install Cassandra</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">sudo dnf install -y cassandra</span>
</pre></div>
</div>
</li>
<li><p>Create keystore for all nodes, including the truststore containing root and intermediate certificates,
here bash script to generate.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span>!/bin/bash

<span class="gp"># </span>Define<span class="w"> </span>directories<span class="w"> </span>and<span class="w"> </span>file<span class="w"> </span>names
<span class="go">DIR=&quot;/home/user/Documents/kkts&quot;</span>
<span class="go">TRUSTSTORE=&quot;truststore.jks&quot;</span>
<span class="go">CLIENT_KEYSTORE=&quot;client.jks&quot;</span>
<span class="go">ROOT_CA_KEY=&quot;root-ca.key&quot;</span>
<span class="go">ROOT_CA_CERT=&quot;root-ca.crt&quot;</span>
<span class="go">INTERMEDIATE_CA_KEY=&quot;intermediate-ca.key&quot;</span>
<span class="go">INTERMEDIATE_CA_CERT=&quot;intermediate-ca.crt&quot;</span>
<span class="go">KEYSTORE_PASS=&quot;cassandra&quot;</span>

<span class="gp"># </span>Create<span class="w"> </span>directories
<span class="go">mkdir -p $DIR</span>

<span class="gp"># </span>Generate<span class="w"> </span>Root<span class="w"> </span>CA<span class="w"> </span>Key<span class="w"> </span>and<span class="w"> </span>Certificate
<span class="go">openssl genrsa -out $DIR/$ROOT_CA_KEY 2048</span>
<span class="go">openssl req -new -x509 -days 3650 -key $DIR/$ROOT_CA_KEY -out $DIR/$ROOT_CA_CERT -subj &quot;/C=ID/ST=Kepri/L=Batam/O=Klavis/CN=Root&quot;</span>

<span class="gp"># </span>Generate<span class="w"> </span>Intermediate<span class="w"> </span>CA<span class="w"> </span>Key<span class="w"> </span>and<span class="w"> </span>Certificate
<span class="go">openssl genrsa -out $DIR/$INTERMEDIATE_CA_KEY 2048</span>
<span class="go">openssl req -new -key $DIR/$INTERMEDIATE_CA_KEY -out $DIR/intermediate-ca.csr -subj &quot;/C=ID/ST=Kepri/L=Batam/O=Klavis/CN=Intermediate&quot;</span>

<span class="gp"># </span>Sign<span class="w"> </span>Intermediate<span class="w"> </span>CA<span class="w"> </span>Certificate<span class="w"> </span>with<span class="w"> </span>Root<span class="w"> </span>CA
<span class="go">openssl x509 -req -in $DIR/intermediate-ca.csr -CA $DIR/$ROOT_CA_CERT -CAkey $DIR/$ROOT_CA_KEY -CAcreateserial -out $DIR/$INTERMEDIATE_CA_CERT -days 1825</span>

<span class="gp"># </span>Create<span class="w"> </span>and<span class="w"> </span>populate<span class="w"> </span>the<span class="w"> </span>TrustStore
<span class="go">keytool -importcert -noprompt -alias rootCA -file $DIR/$ROOT_CA_CERT -keystore $DIR/$TRUSTSTORE -storepass $KEYSTORE_PASS #-storetype jks</span>
<span class="go">keytool -importcert -noprompt -alias intermediateCA -file $DIR/$INTERMEDIATE_CA_CERT -keystore $DIR/$TRUSTSTORE -storepass $KEYSTORE_PASS</span>

<span class="gp"># </span>Generate<span class="w"> </span>and<span class="w"> </span>Import<span class="w"> </span>Client<span class="w"> </span>Certificates<span class="w"> </span>and<span class="w"> </span>Keys
<span class="go">clients=(&quot;kkts&quot; &quot;node1&quot; &quot;node2&quot;)</span>


<span class="go">for client in &quot;${clients[@]}&quot;; do</span>
<span class="gp">    # </span>Generate<span class="w"> </span>Client<span class="w"> </span>Key<span class="w"> </span>and<span class="w"> </span>Certificate
<span class="go">    openssl genrsa -out $DIR/$client.key 2048</span>
<span class="go">    openssl req -new -key $DIR/$client.key -out $DIR/$client.csr -subj &quot;/C=ID/ST=Kepri/L=Batam/O=Klavis/CN=$client&quot;</span>

<span class="gp">    # </span>Sign<span class="w"> </span>Client<span class="w"> </span>Certificate<span class="w"> </span>with<span class="w"> </span>Intermediate<span class="w"> </span>CA
<span class="go">    openssl x509 -req -in $DIR/$client.csr -CA $DIR/$INTERMEDIATE_CA_CERT -CAkey $DIR/$INTERMEDIATE_CA_KEY -CAcreateserial -out $DIR/$client.crt -days 365</span>

<span class="gp">    # </span>Combine<span class="w"> </span>Key<span class="w"> </span>and<span class="w"> </span>Certificate<span class="w"> </span>into<span class="w"> </span>PKCS#12<span class="w"> </span>format<span class="w"> </span><span class="o">(</span>PFX<span class="o">)</span>
<span class="go">    openssl pkcs12 -export -in $DIR/$client.crt -inkey $DIR/$client.key -out $DIR/$client.p12 -name $client -CAfile $DIR/$INTERMEDIATE_CA_CERT -caname intermediateCA -passout pass:$KEYSTORE_PASS</span>

<span class="gp">    # </span>Import<span class="w"> </span>PKCS#12<span class="w"> </span>file<span class="w"> </span>into<span class="w"> </span>the<span class="w"> </span>KeyStore
<span class="go">    keytool -importkeystore -deststorepass $KEYSTORE_PASS -destkeypass $KEYSTORE_PASS -destkeystore $DIR/$client.jks -srckeystore $DIR/$client.p12 -srcstoretype PKCS12 -srcstorepass $KEYSTORE_PASS -alias $client #-storetype jks</span>
<span class="go">done</span>

<span class="gp"># </span>List<span class="w"> </span>certificates<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>TrustStore
<span class="go">echo &quot;Listing certificates in the TrustStore:&quot;</span>
<span class="go">keytool -list -keystore $DIR/$TRUSTSTORE -storepass $KEYSTORE_PASS</span>
</pre></div>
</div>
</li>
<li><p>Run above script, below is example with name file <code class="docutils literal notranslate"><span class="pre">cassandra.file</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">./cassandra.file</span>
</pre></div>
</div>
</li>
<li><p>Generate directory <code class="docutils literal notranslate"><span class="pre">/var/lib/cassandra/data/</span></code></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">sudo mkdir -p /var/lib/cassandra/data/</span>
<span class="go">sudo chown cassandra:cassandra /var/lib/cassandra/data/</span>
</pre></div>
</div>
</li>
<li><p>After generate the certificates, copy to the directory <code class="docutils literal notranslate"><span class="pre">/var/lib/cassandra/data/</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">sudo cp [filename]  /var/lib/cassandra/data/</span>
<span class="go">sudo chown -R cassandra:cassandra /var/lib/cassandra/data/</span>
</pre></div>
</div>
</li>
<li><p>Edit cassandra.yaml configuration file which is located on <code class="docutils literal notranslate"><span class="pre">/etc/cassandra/conf/cassandra.yaml</span></code>,
change the following to all nodes.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cluster_name: &#39;KK-TS Cluster&#39;</span>
</pre></div>
</div>
</li>
<li><p>Assign one node as seed nodes. You can promote additional nodes to seed nodes later, but please promote them one by one.
Do not designate them as seeds during the bootstrap process for a new node.
Below is configuration example with 2 nodes:</p>
<ul class="simple">
<li><p>Node 1: 10.21.0.2</p></li>
<li><p>Node 2: 10.21.0.3</p></li>
</ul>
<p>Edit cassandra.yaml configuration file which is located on <code class="docutils literal notranslate"><span class="pre">/etc/cassandra/conf/cassandra.yaml</span></code>, change the following.</p>
<ul>
<li><p>Node 1</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">seed_provider:</span>
<span class="gp"># </span>Addresses<span class="w"> </span>of<span class="w"> </span>hosts<span class="w"> </span>that<span class="w"> </span>are<span class="w"> </span>deemed<span class="w"> </span>contact<span class="w"> </span>points.
<span class="gp"># </span>Cassandra<span class="w"> </span>nodes<span class="w"> </span>use<span class="w"> </span>this<span class="w"> </span>list<span class="w"> </span>of<span class="w"> </span>hosts<span class="w"> </span>to<span class="w"> </span>find<span class="w"> </span>each<span class="w"> </span>other<span class="w"> </span>and<span class="w"> </span>learn
<span class="gp"># </span>the<span class="w"> </span>topology<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>ring.<span class="w">  </span>You<span class="w"> </span>must<span class="w"> </span>change<span class="w"> </span>this<span class="w"> </span><span class="k">if</span><span class="w"> </span>you<span class="w"> </span>are<span class="w"> </span>running
<span class="gp"># </span>multiple<span class="w"> </span>nodes!
<span class="go">- class_name: org.apache.cassandra.locator.SimpleSeedProvider</span>
<span class="go">parameters:</span>
<span class="gp">    # </span>seeds<span class="w"> </span>is<span class="w"> </span>actually<span class="w"> </span>a<span class="w"> </span>comma-delimited<span class="w"> </span>list<span class="w"> </span>of<span class="w"> </span>addresses.
<span class="gp">    # </span>Ex:<span class="w"> </span><span class="s2">&quot;&lt;ip1&gt;,&lt;ip2&gt;,&lt;ip3&gt;&quot;</span>
<span class="go">    - seeds: &quot;10.21.0.2:7000&quot;</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>

<span class="go">listen_address: 10.21.0.2</span>
<span class="go">rpc_address: 10.21.0.2</span>

<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>

<span class="go">server_encryption_options:</span>
<span class="go">internode_encryption: all</span>
<span class="go">keystore: /var/lib/cassandra/data/node1.jks</span>
<span class="go">keystore_password: cassandra</span>
<span class="go">require_client_auth: true</span>
<span class="go">truststore: /var/lib/cassandra/data/truststore.jks</span>
<span class="go">truststore_password: cassandra</span>
<span class="go">store_type: PKCS12</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">client_encryption_options:</span>
<span class="go">enabled: true</span>
<span class="go">keystore: /var/lib/cassandra/data/node1.jks</span>
<span class="go">keystore_password: cassandra</span>
<span class="go">require_client_auth: true</span>
<span class="go">truststore: /var/lib/cassandra/data/truststore.jks</span>
<span class="go">truststore_password: cassandra</span>
<span class="go">store_type: PKCS12</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">authenticator: PasswordAuthenticator</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>

<span class="go">authorizer: CassandraAuthorizer</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">endpoint_snitch: GossipingPropertyFileSnitch</span>
</pre></div>
</div>
</li>
<li><p>Node 2</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">seed_provider:</span>
<span class="gp"># </span>Addresses<span class="w"> </span>of<span class="w"> </span>hosts<span class="w"> </span>that<span class="w"> </span>are<span class="w"> </span>deemed<span class="w"> </span>contact<span class="w"> </span>points.
<span class="gp"># </span>Cassandra<span class="w"> </span>nodes<span class="w"> </span>use<span class="w"> </span>this<span class="w"> </span>list<span class="w"> </span>of<span class="w"> </span>hosts<span class="w"> </span>to<span class="w"> </span>find<span class="w"> </span>each<span class="w"> </span>other<span class="w"> </span>and<span class="w"> </span>learn
<span class="gp"># </span>the<span class="w"> </span>topology<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>ring.<span class="w">  </span>You<span class="w"> </span>must<span class="w"> </span>change<span class="w"> </span>this<span class="w"> </span><span class="k">if</span><span class="w"> </span>you<span class="w"> </span>are<span class="w"> </span>running
<span class="gp"># </span>multiple<span class="w"> </span>nodes!
<span class="go">- class_name: org.apache.cassandra.locator.SimpleSeedProvider</span>
<span class="go">parameters:</span>
<span class="gp">    # </span>seeds<span class="w"> </span>is<span class="w"> </span>actually<span class="w"> </span>a<span class="w"> </span>comma-delimited<span class="w"> </span>list<span class="w"> </span>of<span class="w"> </span>addresses.
<span class="gp">    # </span>Ex:<span class="w"> </span><span class="s2">&quot;&lt;ip1&gt;,&lt;ip2&gt;,&lt;ip3&gt;&quot;</span>
<span class="go">    - seeds: &quot;10.21.0.2:7000&quot;</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>

<span class="go">listen_address: 10.21.0.3</span>
<span class="go">rpc_address: 10.21.0.3</span>

<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>

<span class="go">server_encryption_options:</span>
<span class="go">internode_encryption: all</span>
<span class="go">keystore: /var/lib/cassandra/data/node2.jks</span>
<span class="go">keystore_password: cassandra</span>
<span class="go">require_client_auth: true</span>
<span class="go">truststore: /var/lib/cassandra/data/truststore.jks</span>
<span class="go">truststore_password: cassandra</span>
<span class="go">store_type: PKCS12</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">client_encryption_options:</span>
<span class="go">enabled: true</span>
<span class="go">keystore: /var/lib/cassandra/data/node2.jks</span>
<span class="go">keystore_password: cassandra</span>
<span class="go">require_client_auth: true</span>
<span class="go">truststore: /var/lib/cassandra/data/truststore.jks</span>
<span class="go">truststore_password: cassandra</span>
<span class="go">store_type: PKCS12</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">authenticator: PasswordAuthenticator</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>

<span class="go">authorizer: CassandraAuthorizer</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">endpoint_snitch: GossipingPropertyFileSnitch</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>Configure rack and DC. Specify rack and DC for each node.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">sudo nano /etc/cassandra/conf/cassandra-rackdc.properties</span>
</pre></div>
</div>
</li>
<li><p>If using multiple datacenters or there is high connection latency between nodes, consider
changing internode request timeout on the <code class="docutils literal notranslate"><span class="pre">/etc/cassandra/conf/cassandra.yaml</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>How<span class="w"> </span>long<span class="w"> </span>the<span class="w"> </span>coordinator<span class="w"> </span>should<span class="w"> </span><span class="nb">wait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>operations<span class="w"> </span>to<span class="w"> </span>complete.
<span class="gp"># </span>Lowest<span class="w"> </span>acceptable<span class="w"> </span>value<span class="w"> </span>is<span class="w"> </span><span class="m">10</span><span class="w"> </span>ms.
<span class="gp"># </span>Min<span class="w"> </span>unit:<span class="w"> </span>ms
<span class="go">read_request_timeout: 5000ms</span>
<span class="gp"># </span>How<span class="w"> </span>long<span class="w"> </span>the<span class="w"> </span>coordinator<span class="w"> </span>should<span class="w"> </span><span class="nb">wait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>seq<span class="w"> </span>or<span class="w"> </span>index<span class="w"> </span>scans<span class="w"> </span>to<span class="w"> </span>complete.
<span class="gp"># </span>Lowest<span class="w"> </span>acceptable<span class="w"> </span>value<span class="w"> </span>is<span class="w"> </span><span class="m">10</span><span class="w"> </span>ms.
<span class="gp"># </span>Min<span class="w"> </span>unit:<span class="w"> </span>ms
<span class="go">range_request_timeout: 10000ms</span>
<span class="gp"># </span>How<span class="w"> </span>long<span class="w"> </span>the<span class="w"> </span>coordinator<span class="w"> </span>should<span class="w"> </span><span class="nb">wait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>writes<span class="w"> </span>to<span class="w"> </span>complete.
<span class="gp"># </span>Lowest<span class="w"> </span>acceptable<span class="w"> </span>value<span class="w"> </span>is<span class="w"> </span><span class="m">10</span><span class="w"> </span>ms.
<span class="gp"># </span>Min<span class="w"> </span>unit:<span class="w"> </span>ms
<span class="go">write_request_timeout: 2000ms</span>
<span class="gp"># </span>How<span class="w"> </span>long<span class="w"> </span>the<span class="w"> </span>coordinator<span class="w"> </span>should<span class="w"> </span><span class="nb">wait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>counter<span class="w"> </span>writes<span class="w"> </span>to<span class="w"> </span>complete.
<span class="gp"># </span>Lowest<span class="w"> </span>acceptable<span class="w"> </span>value<span class="w"> </span>is<span class="w"> </span><span class="m">10</span><span class="w"> </span>ms.
<span class="gp"># </span>Min<span class="w"> </span>unit:<span class="w"> </span>ms
<span class="go">counter_write_request_timeout: 5000ms</span>
<span class="gp"># </span>How<span class="w"> </span>long<span class="w"> </span>a<span class="w"> </span>coordinator<span class="w"> </span>should<span class="w"> </span><span class="k">continue</span><span class="w"> </span>to<span class="w"> </span>retry<span class="w"> </span>a<span class="w"> </span>CAS<span class="w"> </span>operation
<span class="gp"># </span>that<span class="w"> </span>contends<span class="w"> </span>with<span class="w"> </span>other<span class="w"> </span>proposals<span class="w"> </span><span class="k">for</span><span class="w"> </span>the<span class="w"> </span>same<span class="w"> </span>row.
<span class="gp"># </span>Lowest<span class="w"> </span>acceptable<span class="w"> </span>value<span class="w"> </span>is<span class="w"> </span><span class="m">10</span><span class="w"> </span>ms.
<span class="gp"># </span>Min<span class="w"> </span>unit:<span class="w"> </span>ms
<span class="go">cas_contention_timeout: 1000ms</span>
<span class="gp"># </span>How<span class="w"> </span>long<span class="w"> </span>the<span class="w"> </span>coordinator<span class="w"> </span>should<span class="w"> </span><span class="nb">wait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>truncates<span class="w"> </span>to<span class="w"> </span><span class="nb">complete</span>
<span class="gp"># </span><span class="o">(</span>This<span class="w"> </span>can<span class="w"> </span>be<span class="w"> </span>much<span class="w"> </span>longer,<span class="w"> </span>because<span class="w"> </span>unless<span class="w"> </span>auto_snapshot<span class="w"> </span>is<span class="w"> </span>disabled
<span class="gp"># </span>we<span class="w"> </span>need<span class="w"> </span>to<span class="w"> </span>flush<span class="w"> </span>first<span class="w"> </span>so<span class="w"> </span>we<span class="w"> </span>can<span class="w"> </span>snapshot<span class="w"> </span>before<span class="w"> </span>removing<span class="w"> </span>the<span class="w"> </span>data.<span class="o">)</span>
<span class="gp"># </span>Lowest<span class="w"> </span>acceptable<span class="w"> </span>value<span class="w"> </span>is<span class="w"> </span><span class="m">10</span><span class="w"> </span>ms.
<span class="gp"># </span>Min<span class="w"> </span>unit:<span class="w"> </span>ms
<span class="go">truncate_request_timeout: 60000ms</span>
<span class="gp"># </span>The<span class="w"> </span>default<span class="w"> </span>timeout<span class="w"> </span><span class="k">for</span><span class="w"> </span>other,<span class="w"> </span>miscellaneous<span class="w"> </span>operations.
<span class="gp"># </span>Lowest<span class="w"> </span>acceptable<span class="w"> </span>value<span class="w"> </span>is<span class="w"> </span><span class="m">10</span><span class="w"> </span>ms.
<span class="gp"># </span>Min<span class="w"> </span>unit:<span class="w"> </span>ms
<span class="go">request_timeout: 10000ms</span>
</pre></div>
</div>
</li>
<li><p>By default, Cassandra has several directory configurations, as identified by the command below.
You can change the directory paths to match the directories you use.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>Directories<span class="w"> </span>where<span class="w"> </span>Cassandra<span class="w"> </span>should<span class="w"> </span>store<span class="w"> </span>data<span class="w"> </span>on<span class="w"> </span>disk.<span class="w"> </span>If<span class="w"> </span>multiple
<span class="gp"># </span>directories<span class="w"> </span>are<span class="w"> </span>specified,<span class="w"> </span>Cassandra<span class="w"> </span>will<span class="w"> </span>spread<span class="w"> </span>data<span class="w"> </span>evenly<span class="w"> </span>across
<span class="gp"># </span>them<span class="w"> </span>by<span class="w"> </span>partitioning<span class="w"> </span>the<span class="w"> </span>token<span class="w"> </span>ranges.
<span class="gp"># </span>If<span class="w"> </span>not<span class="w"> </span>set,<span class="w"> </span>the<span class="w"> </span>default<span class="w"> </span>directory<span class="w"> </span>is<span class="w"> </span><span class="nv">$CASSANDRA_HOME</span>/data/data.
<span class="go">data_file_directories:</span>
<span class="go">    - /var/lib/cassandra/data</span>
</pre></div>
</div>
</li>
<li><p>Configure firewall to allow in and out connection on port 7000 and 9042 on all machine.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">sudo firewall-cmd --permanent --zone=public --add-port=7000/tcp</span>
<span class="go">sudo firewall-cmd --permanent --zone=public --add-port=9042/tcp</span>
<span class="go">sudo firewall-cmd --reload</span>
</pre></div>
</div>
</li>
<li><p>Install systemd</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">sudo dnf install systemd</span>
</pre></div>
</div>
</li>
<li><p>Install initscripts</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">sudo dnf install initscripts</span>
</pre></div>
</div>
</li>
</ul>
<p>At this time, before you start the Cassandra service, you allowed to set YAML and JVM configuration.</p>
<p>Execute commands below on each node. Please start the service sequentially. One node must succeed first before continuing to the next node.</p>
<ul>
<li><p>Start the Cassandra service.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>service<span class="w"> </span>cassandra<span class="w"> </span>start
</pre></div>
</div>
</li>
<li><p>Ensure that the node up by checking the service</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>cassandra
<span class="gp">$ </span>nodetool<span class="w"> </span>status
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you encounter any problems, check the log on <code class="docutils literal notranslate"><span class="pre">/var/log/cassandra/cassandra.log</span></code>.</p>
</div>
</li>
<li><p>Check if it’s running correct configuration.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>nodetool<span class="w"> </span>info
</pre></div>
</div>
</li>
</ul>
</li>
</ol>
</section>
<section id="cqlsh-setup">
<h2>Cqlsh Setup<a class="headerlink" href="#cqlsh-setup" title="Link to this heading"></a></h2>
<blockquote>
<div><p>Cqlsh is a command line interface for interacting with Cassandra using CQL (Cassandra Query Language).
Cqlsh is implemented with Python native protocol driver, and connects to the single specified node.</p>
<ul>
<li><p>Install properties</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>pip
</pre></div>
</div>
</li>
<li><p>Install Cqlsh</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>pip<span class="w"> </span>install<span class="w"> </span>cqlsh
</pre></div>
</div>
</li>
<li><p>Create file <code class="docutils literal notranslate"><span class="pre">cqlshrc</span></code> on <code class="docutils literal notranslate"><span class="pre">$HOME/.cassandra</span></code> directory. Insert script below and use the
previously generated certificate from same CA.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">[connection]</span>
<span class="go">factory = cqlshlib.ssl.ssl_transport_factory</span>

<span class="go">[ssl]</span>
<span class="go">certfile = /home/user/root-ca.crt</span>
<span class="go">validate = false</span>
<span class="go">userkey = /home/user/kkts.key</span>
<span class="go">usercert = /home/user/kkts.crt</span>
</pre></div>
</div>
</li>
<li><p>Start cqlsh and connect it to node 1 by using default superuser name and password (user = cassandra, password = cassandra).</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cqlsh<span class="w"> </span>node1<span class="w"> </span>--ssl<span class="w"> </span>-u<span class="w"> </span>cassandra
</pre></div>
</div>
</li>
<li><p>Alter system_auth to replicate authentication and authorization. The defautlt replication factor for the system_auth is 1,
increase it to same as of the number of nodes to ensure the keyspace is always available.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ALTER KEYSPACE system_auth WITH replication = {&#39;class&#39;: &#39;SimpleStrategy&#39;, &#39;datacenter1&#39;: 2};</span>
</pre></div>
</div>
</li>
<li><p>After update the replication factor, run nodetool repair to make certain change is propagated:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">nodetool repair system_auth</span>
</pre></div>
</div>
</li>
<li><p>Restart Cassandra service.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>service<span class="w"> </span>cassandra<span class="w"> </span>start
</pre></div>
</div>
</li>
<li><p>Start the cqlsh.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cqlsh<span class="w"> </span>node1<span class="w"> </span>--ssl<span class="w"> </span>-u<span class="w"> </span>cassandra
</pre></div>
</div>
</li>
<li><p>Replace the default superuser “cassandra” with another superuser to prevent security breaches.
It identified by different name. Create your own db administrator.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>CREATE<span class="w"> </span>ROLE<span class="w"> </span>dba<span class="w"> </span>WITH<span class="w"> </span><span class="nv">SUPERUSER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span>AND<span class="w"> </span><span class="nv">LOGIN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span>AND<span class="w"> </span><span class="nv">PASSWORD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;super&#39;</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Exit the cqlsh and reconnect using new dba user.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cqlsh node1 --ssl -u dba</span>
</pre></div>
</div>
</li>
<li><p>The default superuser “cassandra” cannot be deleted from Cassandra. To neutralize the account,
change the password to something long and incomprehensible, and alter the user’s status to NOSUPERUSER by query.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ALTER<span class="w"> </span>ROLE<span class="w"> </span>cassandra<span class="w"> </span>WITH<span class="w"> </span><span class="nv">PASSWORD</span><span class="o">=</span><span class="s1">&#39;SomeNonsenseThatNoOneWillThinkOf&#39;</span><span class="w"> </span>AND<span class="w"> </span><span class="nv">SUPERUSER</span><span class="o">=</span>false<span class="p">;</span>
</pre></div>
</div>
<p>or disable the default superuser access</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ALTER<span class="w"> </span>ROLE<span class="w"> </span>cassandra<span class="w"> </span>WITH<span class="w"> </span><span class="nv">SUPERUSER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="w"> </span>AND<span class="w"> </span><span class="nv">LOGIN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>false<span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Create user for KK-TS namespace.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>CREATE<span class="w"> </span>ROLE<span class="w"> </span>kkts<span class="w"> </span>WITH<span class="w"> </span><span class="nv">SUPERUSER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="w"> </span>AND<span class="w"> </span><span class="nv">LOGIN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span>AND<span class="w"> </span><span class="nv">PASSWORD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span>Klavis1!<span class="sb">`</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Follow <a class="reference internal" href="#kk-ts-namespace-setup"><span class="std std-ref">KK-TS namespace setup</span></a>,
then grant all access to kkts keyspace</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>GRANT<span class="w"> </span>ALL<span class="w"> </span>ON<span class="w"> </span>KEYSPACE<span class="w"> </span>kkts<span class="w"> </span>TO<span class="w"> </span>kkts<span class="p">;</span>
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</section>
<section id="kk-ts-namespace-setup">
<h2>KK-TS Namespace Setup<a class="headerlink" href="#kk-ts-namespace-setup" title="Link to this heading"></a></h2>
<blockquote>
<div><p>Run these command on cqlsh</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">CREATE KEYSPACE IF NOT EXISTS kkts WITH replication = {&#39;class&#39;: &#39;NetworkTopologyStrategy&#39;, &#39;datacenter1&#39;: 3};</span>
<span class="go">CREATE TABLE IF NOT EXISTS kkts.AppConfig (m_appSKI VARCHAR PRIMARY KEY, m_partitionId BIGINT, m_keyId VARCHAR) WITH caching = {&#39;keys&#39;: &#39;ALL&#39;, &#39;rows_per_partition&#39;: &#39;ALL&#39;} AND compaction = { &#39;class&#39; : &#39;LeveledCompactionStrategy&#39; } AND compression = {&#39;class&#39;: &#39;LZ4Compressor&#39;, &#39;chunk_length_in_kb&#39;: 4 };</span>
<span class="go">CREATE TABLE IF NOT EXISTS kkts.AppName (m_appName VARCHAR PRIMARY KEY, m_appSKI VARCHAR) WITH caching = {&#39;keys&#39;: &#39;ALL&#39;, &#39;rows_per_partition&#39;: &#39;ALL&#39;} AND compaction = { &#39;class&#39; : &#39;LeveledCompactionStrategy&#39; } AND compression = {&#39;class&#39;: &#39;LZ4Compressor&#39;, &#39;chunk_length_in_kb&#39;: 4 };</span>
<span class="go">CREATE TABLE IF NOT EXISTS kkts.DataConfig (m_appSKI VARCHAR, m_configId VARCHAR, m_tokenType BIGINT, m_formattingCharacters VARCHAR, m_tokenizedWith BIGINT, m_minimumLength BIGINT, PRIMARY KEY(m_appSKI, m_configId)) WITH caching = {&#39;keys&#39;: &#39;ALL&#39;, &#39;rows_per_partition&#39;: &#39;ALL&#39;} AND compaction = { &#39;class&#39; : &#39;LeveledCompactionStrategy&#39; } AND compression = {&#39;class&#39;: &#39;LZ4Compressor&#39;, &#39;chunk_length_in_kb&#39;: 4 };</span>
<span class="go">CREATE TABLE IF NOT EXISTS kkts.AppConfigACL (m_masterAppSKI VARCHAR, m_slaveAppSKI VARCHAR, PRIMARY KEY ((m_masterAppSKI, m_slaveAppSKI))) WITH caching = {&#39;keys&#39;: &#39;ALL&#39;, &#39;rows_per_partition&#39;: &#39;ALL&#39;} AND compaction = { &#39;class&#39; : &#39;LeveledCompactionStrategy&#39; };</span>
</pre></div>
</div>
<p>If you have multiple datacenter (for example 3 nodes in datacenter2), the KK-TS keyspace creation will be:
<code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">KEYSPACE</span> <span class="pre">IF</span> <span class="pre">NOT</span> <span class="pre">EXISTS</span> <span class="pre">kkts</span> <span class="pre">WITH</span> <span class="pre">replication</span> <span class="pre">=</span> <span class="pre">{'class':</span> <span class="pre">'SimpleStrategy',</span> <span class="pre">'datacenter1':</span> <span class="pre">2};</span></code></p>
</div></blockquote>
</section>
<section id="yaml-configuration">
<h2>YAML Configuration<a class="headerlink" href="#yaml-configuration" title="Link to this heading"></a></h2>
<blockquote>
<div><p>File configuration: <code class="docutils literal notranslate"><span class="pre">etc/cassandra/conf/cassandra.yaml</span></code></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">disk_optimization_strategy</span></code>: optimizing disk read, <code class="docutils literal notranslate"><span class="pre">ssd</span></code> or <code class="docutils literal notranslate"><span class="pre">spinning</span></code> for HDD</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">concurrent_Reads</span></code>: 16*number_of_drives</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">concurrent_counter_writes</span></code>: same as concurrent_Reads</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">concurrent_writes</span></code>: 8*number_of_cores</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">concurrent_materialized_view_writes</span></code>: less of concurrent reads or concurrent writes</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">concurrent_compactors</span></code>: number of cores if using ssd</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">compaction_throughput</span></code>: <code class="docutils literal notranslate"><span class="pre">0MiB/s</span></code> to remove throttle</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">paxos_variant</span></code>: <code class="docutils literal notranslate"><span class="pre">v2</span></code> use newest paxos</p></li>
</ul>
</div></blockquote>
</section>
<section id="jvm-configuration">
<h2>JVM Configuration<a class="headerlink" href="#jvm-configuration" title="Link to this heading"></a></h2>
<blockquote>
<div><figure class="align-default">
<img alt="../_images/cassandra_heap_memory.png" src="../_images/cassandra_heap_memory.png" />
</figure>
<p>File configuration: <code class="docutils literal notranslate"><span class="pre">/etc/cassandra/conf/jvm-server.options</span></code></p>
<p>32 GB RAM configuration:</p>
<ul class="simple">
<li><p>Xms16GB: min heap size, 16GB to spare some for page cache.</p></li>
<li><p>Xmx16GB: max heap size, 16GB to avoid stop-the-world during resize.</p></li>
<li><p>Comment Xmn setting</p></li>
</ul>
<p>File configuration: <code class="docutils literal notranslate"><span class="pre">/etc/cassandra/conf/jvm11-server.options</span></code></p>
<ul class="simple">
<li><p>X:+UseG1GC</p></li>
<li><p>XX:+ParallelRefProcEnabled</p></li>
<li><p>XX:MaxTenuringThreshold=6</p></li>
<li><p>comment CMS setting</p></li>
</ul>
</div></blockquote>
</section>
<section id="configuring-kk-ts-to-kk-cs-and-apache-cassandra">
<h2>Configuring KK-TS to KK-CS and Apache Cassandra<a class="headerlink" href="#configuring-kk-ts-to-kk-cs-and-apache-cassandra" title="Link to this heading"></a></h2>
<ol class="arabic">
<li><p>Set KK-TS port.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kk-ts<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>--kkts-server-port<span class="o">=</span><span class="m">8080</span>
</pre></div>
</div>
</li>
<li><p>Configure KK-TS with KK-CS.</p>
<ul>
<li><p>Set the connection port and host for KK-CS. Please use the SDK port specified on KK-CS.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kk-ts<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>--kkcs-connection-host<span class="o">=</span><span class="m">10</span>.30.0.6<span class="w"> </span>--kkcs-connection-port<span class="o">=</span><span class="m">8088</span>
</pre></div>
</div>
</li>
<li><p>Set the KK-TS private key and certificate created in process <a class="reference internal" href="#installing-kk-tokenization-service"><span class="std std-ref">installing KK-Tokenization Service</span></a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kk-ts<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>--kkcs-connection-appcertificate<span class="o">=</span>KKTSCertificate.pem<span class="w"> </span>--kkcs-connection-appprivatekey<span class="o">=</span>KKTSprivate.key
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>Configure KK-TS with Apache Cassandra.</p>
<ul>
<li><p>Set the connection port and host of Cassandra.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kk-ts<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>--cassandra-connection-host<span class="o">=</span><span class="m">10</span>.30.0.2<span class="w"> </span>--cassandra-connection-port<span class="o">=</span><span class="m">8001</span>
</pre></div>
</div>
</li>
<li><p>Set the username and password of Cassandra.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kk-ts<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>--cassandra-connection-user<span class="o">=</span>CassandraKlavis<span class="w"> </span>--cassandra-connection-password<span class="o">=</span>CassandraKlavis1!
</pre></div>
</div>
</li>
<li><p>Set the private key and certificate of Cassandra.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kk-ts<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>--cassandra-connection-certificate<span class="o">=</span>/path/to/cassandrakktscertificate.crt<span class="w"> </span>--cassandra-connection-privatekey<span class="o">=</span>/path/to/cassandrakkts.key
</pre></div>
</div>
</li>
</ul>
</li>
</ol>
</section>
<section id="apply-kk-ts-license-and-run-the-kk-ts">
<h2>Apply KK-TS License and Run the KK-TS<a class="headerlink" href="#apply-kk-ts-license-and-run-the-kk-ts" title="Link to this heading"></a></h2>
<ol class="arabic">
<li><p>Request the license to RSI and apply this to KK-TS. Detailed on <a class="reference internal" href="kkts-license.html#kk-ts-license"><span class="std std-ref">KK-TS License</span></a></p></li>
<li><p>Enable and start the KK-TS service.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>kk-tsd<span class="w"> </span>--now
</pre></div>
</div>
</li>
<li><p>Check the status the KK-TS service, ensure that the service active.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>kk-tsd
</pre></div>
</div>
</li>
</ol>
</section>
<section id="generating-client-certificate-and-configuring-the-client-application-to-kk-ts">
<h2>Generating Client Certificate and Configuring the Client Application to KK-TS<a class="headerlink" href="#generating-client-certificate-and-configuring-the-client-application-to-kk-ts" title="Link to this heading"></a></h2>
<ol class="arabic">
<li><p>Generate Client Certificate</p>
<ul>
<li><p>Generate the application’s key pair. This example generates an ECDSA P-256 key pair.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>ecparam<span class="w"> </span>-name<span class="w"> </span>prime256v1<span class="w"> </span>-genkey<span class="w"> </span>-noout<span class="w"> </span>-out<span class="w"> </span>client_private.key
</pre></div>
</div>
</li>
<li><p>Create the CSR for the key pair.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-sha256<span class="w"> </span>-key<span class="w"> </span>client_private.key<span class="w"> </span>-out<span class="w"> </span>client_csr.pem
</pre></div>
</div>
</li>
<li><p>Generate client certificate using KK-TS command.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kk-ts<span class="w"> </span>client-app<span class="w"> </span>gen-cert<span class="w"> </span>--csr-path<span class="o">=</span>/path/to/client_csr.pem<span class="w"> </span>--output-cert-path<span class="o">=</span>/path/to/output/client_cert.pem
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>Configure the Client Application to KK-Tokenization Service.</p>
<ul>
<li><p>Before you start using vault-based tokenization please do client <a class="reference internal" href="command-line-interface.html#application-configuration"><span class="std std-ref">Application configuration</span></a>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kk-ts<span class="w"> </span>appconfig<span class="w"> </span>add<span class="w"> </span>--app-name<span class="o">=</span>AppOne<span class="w"> </span>--certificate-file<span class="o">=</span>client_cert.pem<span class="w"> </span>--partition-id<span class="o">=</span><span class="m">1</span><span class="w"> </span>--key-id<span class="o">=</span>01aes
</pre></div>
</div>
</li>
<li><p>For the tokenization service functionality, add data config with specific data format. Data format detailed on <a class="reference internal" href="domain-configuration.html#data-configuration"><span class="std std-ref">data configuration</span></a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kk-ts<span class="w"> </span>dataconfig<span class="w"> </span>add<span class="w"> </span>--app-ski<span class="o">=</span>656cf721a1efc325d44181c1e877445efc3079ae<span class="w"> </span>--config-id<span class="o">=</span>PhoneNumber<span class="w"> </span>--token-type<span class="o">=</span><span class="m">1</span><span class="w"> </span>--tokenized-with<span class="o">=</span><span class="m">2</span><span class="w"> </span>--minimum-length<span class="o">=</span><span class="m">8</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="design-motivation.html" class="btn btn-neutral float-left" title="Design motivation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="kkts-backuprestore.html" class="btn btn-neutral float-right" title="KK-Tokenization Service Backup and Restore" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, PT Klavis Kripta Inovasi.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>